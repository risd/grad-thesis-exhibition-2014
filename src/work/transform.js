// requires d3.scale.ordinal
module.exports = transform;

function transform () {
    return function (input) {
        var formatted = format_data_cover_with_modules(input);
        // return suffle(formatted);
        return formatted;
    };
}

function format_data_cover_with_modules (data) {

    var formatted_data = [];

    // determine the extent of widths
    var all_modules = [];
    data.forEach(function (d, i) {
        d.details.modules.forEach(function (md, mi) {
            if (md.type === 'image') {
                all_modules.push(md);
            }
        });
    });

    // set a scale for mapping
    // width the an image to the
    // width of the masonic version
    var width_extent = d3.extent(all_modules, function (d) {
                        return d.width; }
                    );
    console.log('width_extent');
    console.log(width_extent);
    var widths = d3.scale.ordinal()
        .domain(width_extent)
        .range([100, 200, 400]);
    // var widths = d3.scale.identity()
    //     .domain(width_extent);

    data.forEach(function (d, i) {
        var modules_to_include = [];
        d.details.modules.forEach(function (md, mi) {
            if (md.type === 'image') {
                modules_to_include.push(md);
            }
        });

        // random_cover_option
        var random_module =
            modules_to_include[Math.floor(Math.random() *
                               modules_to_include.length)];

        var random_cover = {
            original_width: +random_module.width,
            original_height: +random_module.height,
            width: widths(random_module.width),
            src: random_module.src
        };
        random_cover.height = (random_cover.width*
                               random_module.height)/
                              random_module.width;

        formatted_data.push({
            'project_name': d.name,
            'student_name': d.owners[0].display_name,
            'risd_program': escape_department(d.risd_program),
            'modules': modules_to_include,
            'cover': random_cover,
            description: d.details.description,
            avatar: d.owners[0].images['138'],
            url: d.owners[0].url
        });
    });

    return formatted_data;
}

function shuffle (o) {
    for(var j, x, i = o.length;
        i;
        j = Math.floor(Math.random() * i),
        x = o[--i], o[i] = o[j], o[j] = x);
    return o;
}

function escape_department(d) {
    return d.toLowerCase().replace(' ', '-');
}
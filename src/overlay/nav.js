var Button = require('./button');

module.exports = function nav () {
    var self = {},
        target_sel,
        overlaid = false,
        body_sel = d3.select('body'),
        window_sel = d3.select(window),
        removable_text = [{
            text: 'Go!'
        }];

    var button = Button();

    self.dispatch = d3.dispatch('asteriskClick');

    self.selection = function (_) {
        if (!arguments.length) return target_sel;
        target_sel = _;

        button
            .selection(target_sel)
            .start();

        return self;
    };

    self.overlaid = function (_) {
        if (!arguments.length) return overlaid;
        overlaid = _;
        return self;
    };

    self.setup = function () {
        if (!target_sel) throw "requires elements to pair";
        target_sel
            .on('click.nav', function (d, di) {
                target_sel
                    .select('#flower');
                overlaid = overlaid ? false : true;
                activate_deactivate(d);
                self.dispatch.asteriskClick(overlaid);
            });

        
        place_button();

        window_sel
            .on('resize.nav', function () {
                place_button();
            });
    };

    function activate_deactivate (d) {
        var overlay = d3.selectAll(d.activate);
        overlay.classed('overlaid', overlaid);
        body_sel.classed('no-scroll', overlaid);
        body_sel.classed(d.body, overlaid);
        place_button();
    }

    function place_button () {
        var wwidth = window.innerWidth;
        var wheight = window.innerHeight;

        var matching_sel;
        var bbox;

        if (overlaid) {
            bbox = target_sel.node().getBoundingClientRect();
            var p_bbox = target_sel
                                .select('p')
                                .node()
                                .getBoundingClientRect();
            
            var target_height = bbox.height;
            matching_sel =
                d3.select('.logo-text-component--risd');
            
            target_sel.style('left', (wwidth +
                                      p_bbox.width -
                                      bbox.width -
                                      (+matching_sel
                                        .style('left')
                                        .split('p')[0])) +
                                     'px');
            target_sel.style('bottom', (wheight -
                                        bbox.height -
                                        (+matching_sel
                                           .style('top')
                                           .split('p')[0])) +
                                       'px');
        } else {
            if (wwidth < 768) {
                bbox = target_sel.node().getBoundingClientRect();
                matching_sel =
                    d3.select('.logo-text-component--show');
                var matching_box = matching_sel
                                        .node()
                                        .getBoundingClientRect();
                
                target_sel
                    .style('left', ((wwidth - bbox.width)/2) +
                                           'px')
                    .style('bottom', ((+matching_sel
                                        .style('bottom')
                                        .split('p')[0]) -
                                      (bbox.height-
                                       matching_box.height)/2) +
                                     'px');
            } else {
                matching_sel =
                    d3.select('.logo-text-component--2014');
                target_sel
                    .style('left', matching_sel.style('right'))
                    .style('bottom', matching_sel.style('bottom'));
            }
        }
    }

    return self;
};